# redis 编码 intset

OBJ_ENCODING_INTSET

## 作用于

OBJ_SET

## 数据结构

![img](res/redis-encoding-intset.png)

```c
typedef struct intset {
    uint32_t encoding;      // 编码方式; 数组元素的类型
    uint32_t length;        // 包含元素数量; contents的长度
    int8_t contents[];      // 包含元素的数组; 按值从小到大排列，不重复。
} intset;
```

## 升级

添加比集合中元素类型更长的新元素，需要先升级。(如 [1,2,3] -> [1,2,3,65535]即int16升级int32)

### 步骤

1. 根据新元素类型扩展底层数组空间，并为新元素分配空间。
2. 将原元素转换成新类型，按序分配。
3. 将新元素添加到新底层数组中。

> 数组地址不变，按新类型向后扩容，元素有序性不变。

## 降级

不支持降级

## 特性

## API

| 函数名称      | 作用                             | 复杂度                                                                     |
| ------------- | -------------------------------- | -------------------------------------------------------------------------- |
| intsetNew     | 创建一个新的整数集合。           | O(1)                                                                       |
| intsetAdd     | 将给定元素添加到整数集合里面。   | O(N)                                                                       |
| intsetRemove  | 从整数集合中移除给定元素。       | O(N)                                                                       |
| intsetFind    | 检查给定值是否存在于集合。       | 因为底层数组有序，查找可以通过二分查找法来进行， 所以复杂度为 O(\log N) 。 |
| intsetRandom  | 从整数集合中随机返回一个元素。   | O(1)                                                                       |
| intsetGet     | 取出底层数组在给定索引上的元素。 | O(1)                                                                       |
| intsetLen     | 返回整数集合包含的元素个数。     | O(1)                                                                       |
| intsetBlobLen | 返回整数集合占用的内存字节数。   | O(1)                                                                       |

## issues

- 集合元素互斥性如何保证？

排序的
