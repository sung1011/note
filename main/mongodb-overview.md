# mongodb 概述

## 版本

- 0.x 起步(2008)
- 1.x 支持复制集和分片集(2010)
- 2.x 更丰富的数据库功能(2012)
- 3.x WiredTiger和周边生态环境(2014)
- 4.x 分布式事务支持(2018)

## 对比SQL

|            | MongoDB                   | RDBMS                |
| ---------- | ------------------------- | -------------------- |
| 数据模型   | 文档模型                  | 关系模型             |
| 数据库类型 | OLTP                      | OLTP                 |
| CURL类型   | nosql                     | sql                  |
| 高可用     | 复制集                    | 集群模式             |
| 横向扩展   | 原生分片                  | 数据分区or应用侵入式 |
| 索引       | B-、全文、地理、多键、TTL | B+tree               |
| 开发难度   | 简单                      | 复杂                 |
| 数据容量   | 无上限                    | 千万、亿             |
| 扩展方式   | 垂直+横向                 | 横向                 |

> MongoDB的b-tree索引 更适合_id进行查找, 不适合范围/遍历查找; 建议多设计内嵌文档规避where条件

## 资源

- 内存
- IO

## 流程

### 应用端

                      (有) -----------------------------------------------
                       /                                (是) 异常退出     |
                      /                                   /             |
                     /               (是) --- 排队 --- 超时(否) -----------
                    /                /                                  |
    选择节点 --- 获取连接(无) --- 连接上限(否) --- 认证 --- 建立连接 --- 占用连接 --- 发起请求 --- {Server}

    {Server} --- 获取结果 --- 释放连接 --- 正常结束

> 选择节点: replset

> 连接上限: 常常是S处理慢, 而非连接池小

> 认证慢: 设置minPoolSize(最小连接数)一次性创建足够的连接; 避免突发大量请求

### 服务端

```bash
                                                                (是)异常退出
                                                               /
       (否) --- 所有片执行 -------------           排队等待 --- 超时(否)                                (否)合并结果返回
      /                             /           /             /                                     /
    片键(是) --- 特定片执行 --- 评估执行计划 --- ticket(有) --- 占用ticket --- 执行 --- 释放ticket --- 特定片(是) --- 直接返回
```

> ticket不足: 优化CURD性能;  zlib压缩比较耗时

> 分片的合并返回: mongos

### 读

```bash
    执行 --- 数据、索引写入缓存 --- 搜索(索引扫描O(log2n), 集合扫描O(n)) --- 排序(索引排序, 集合排序)
```

### 写

```bash
                                              先写journal
                                             /     /
    执行 --- 定位(索引扫描O(log2n)、集合扫描O(n)) --- 写缓存
```

> 写缓存: 事务性写入oplog、索引、数据

> [journal](mongodb-journal.md)

## 性能瓶颈

| 应用端         | 服务端     | 网络          |
| -------------- | ---------- | ------------- |
| 选择节点       | 排队ticket | 应用 - mongos |
| 等待连接       | 执行读写   | mongos - 片   |
| 创建连接与认证 | 合并结果   |
