# 浮点数 float

## 浮点数

浮点数是指用符号、尾数、基数和指数这四部分来表示的小数

```js
            符号sign    
             |         基数base
             |         |
    2020.9 = +2.0209 x 10^3
                |         |
                |         指数exponent
                尾数mantissa
```

## 定点数

todo

## 小数的二/十进制互相转换

### dec to bin

```js
(dec)11 ==> (bin)1101
    11/2=5 … 余1
    5/2=2  … 余1
    2/2=1  … 余0
    1/2=0  … 余1
 #除 2 取余, 逆序排列

(dec)0.625 ==> (bin)0.101
    0.625*2=1.25 … 取整数部分1
    0.25*2=0.5 	 … 取整数部分0
    0.5*2=1	     … 取整数部分1
# 乘 2 取整, 顺序排列
```

### bin to dec

```js
(bin)0.101 = 1×2⁻¹ + 0×2⁻² + 0×2⁻³ = (dec)0.625
```

## IEEE754

一套具体的表示和运算浮点数的标准  
IEEE754只关注符号, 尾数, 指数. 不关注基数(固定为2)

| float  | 占用位 | 占用字节 | 符号位sign | 指数位exponent | 尾数位mantissa | 图示                                                               |
| ------ | ------ | -------- | ---------- | -------------- | -------------- | ------------------------------------------------------------------ |
| 双精度 | 64     | 8        | 1          | 11             | 52             | # ########### #################################################### |
| 单精度 | 32     | 4        | 1          | 8              | 23             | # ######## #######################                                 |

### 实例分析

- [script链接](src/go/basic/float_test.go)
- web链接 <https://baseconvert.com/ieee-754-floating-point>

```js
# (float)0.15625

1. 0.15625转化为二进制是0.00101
1. IEEE754规定第1位永远为1, 为此执行逻辑右移3位, 0.00101变为尾数1.01 指数-3
1. 最终二进制结果为 0-01111100-01000000000000000000000


#### 符号位 sign `0`

1. 0代表正数
1. 1代表负数


#### 指数位 exponent `01111100`

1. 指数-3在存储时, 为了避免使用符号位, 同时方便比较排序, 采用 The Biased exponent（有偏指数）
1. 规定2^(e-1)的值是0, 对于float即2^(8-1)=127是0; 对于double即2^(11-1)=1023是0
1. 因此-3对应的值为(dec)127-3 = (dec)125 = (bin)01111100


#### 尾数位 mantissa `01000000000000000000000`

1. 由于第1位永远1, 所以可以不存, 只存小数点后部分, 1.01即 01, 尾数最终为01000000000000000000000
```

| dec     | 精度   | sign | exponent | mantissa                                                | bin                                                                |
| ------- | ------ | ---- | -------- | ------------------------------------------------------- | ------------------------------------------------------------------ |
| 0.15625 | float  | 0    | 01111100 | 01000000000000000000000                                 | 0-01111100-01000000000000000000000                                 |
| 0.15625 | double | 0    | 01111111 | 1000100000000000000000000000000000000000000000000000000 | 0-01111111-1000100000000000000000000000000000000000000000000000000 |
| 2.75    | float  | 0    | 10000000 | 01100000000000000000000                                 | 0-10000000-01100000000000000000000                                 |

## review

```js
二进制 0.1，用十进制表示的话是多少？十进制的 0.1，用二进制表示又是多少？
为什么 0.1 + 0.2 = 0.30000000000000004？
单精度和双精度浮点数的有效小数位分别是多少？
单精度浮点数能表示的范围是什么？
浮点数为什么会存在 -0？infinity 和 NaN 又是怎么表示的？
```

## 精度bug

    由于连续的二进制数对应的十进制却是不连续的
    只能增加二进制的位数(指尾数的位数)来尽可能近似表示(float:23, double:52)

| bin    | dec    |
| ------ | ------ |
| 0.0000 | 0      |
| 0.0001 | 0.0625 |
| 0.0010 | 0.125  |
| 0.0011 | 0.1875 |
| 0.0100 | 0.25   |
| 0.0101 | 0.3125 |
| 0.0110 | 0.4375 |
| 0.0111 | 0.5    |

### 实例分析

0.1+0.2 = 0.30000000000000004

| dec             | dec-exact                     | bin                                |
| --------------- | ----------------------------- | ---------------------------------- |
| (float) 0.1     | 0.100000001490116119384765625 | 0 01111011 10011001100110011001101 |
| (float) 0.2     | 0.20000000298023223876953125  | 0 01111100 10011001100110011001101 |
| (float) 0.1+0.2 | 0.300000004470348358154296875 |
| (float) 0.3     | 0.300000011920928955078125    | 0 01111101 00110011001100110011010 |

## 特殊值

### infinity（无穷）

    超过浮点数限制, 则表达为正负无穷

| dec                | dec-exact | bin                                                                |
| ------------------ | --------- | ------------------------------------------------------------------ |
| (float) Infinity   | Infinity  | 0 11111111 00000000000000000000000                                 |
| (float) -Infinity  | -Infinity | 1 11111111 00000000000000000000000                                 |
| (double) Infinity  | Infinity  | 0 11111111111 0000000000000000000000000000000000000000000000000000 |
| (double) -Infinity | -Infinity | 1 11111111111 0000000000000000000000000000000000000000000000000000 |

### NaN not-a-number

    指数位全是 1，尾数位不全是 0。
    表达无法计算的数字, 如对-1开根号

| dec | dec-exact | bin                                |
| --- | --------- | ---------------------------------- |
| NaN | NaN       | 0 11111111 10000000000000000000000 |

### Min Max

| name       | dec                                                | sign | exponent    | mantissa                                             |
| ---------- | -------------------------------------------------- | ---- | ----------- | ---------------------------------------------------- |
| max float  | 3.40282346638528859811704183484516925440e+38       | 0    | 11111110    | 11111111111111111111111                              |
| min float  | 1.401298464324817070923729583289916131280e-45      | 0    | 00000000    | 00000000000000000000001                              |
| max double | 1.79769313486231570814527423731704356798070e+308   | 0    | 11111111110 | 1111111111111111111111111111111111111111111111111111 |
| min double | 4.9406564584124654417656879286822137236505980e-324 | 0    | 00000000000 | 0000000000000000000000000000000000000000000000000001 |

> `非规划浮点数` max min是一种特殊处理, 详见ref

## ref

- 图解浮点数相关概念<https://polarisxu.studygolang.com/posts/basic/diagram-float-point/>
- 浮点数vs定点数<https://www.jianshu.com/p/43830cdcca30>
- <https://blog.csdn.net/weixin_43679037/article/details/121531768>
- <https://zhuanlan.zhihu.com/p/63897066>