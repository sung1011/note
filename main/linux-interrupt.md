# 中断

## 概念

由于内外部事件，CPU中断当前运行的程序处理，转而处理该事件，处理完后继续运行暂停的程序。

### 上半部/硬中断

在中断禁止模式下运行，快速处理。主要处理**硬件相关**或**时间敏感**的工作。

### 下半部/软中断

延迟处理上半部未完成的工作，通常以**内核线程**方式运行。

## 解读

### 外卖0

你定了一份外卖，无法了解配送进度，只能啥都不干苦苦等待  

### 外卖1 ---- 中断雏形

基于外卖0，你可以去做别的事儿（处理something），但约定外卖员送到给你打电话（中断）， 电话来了去取外卖吃外卖（处理事件），回来后继续做别的事儿（继续处理something）。

> 问题： 如果你定了2份外卖，他们同时送达，A外卖给你打电话用时长了些如商量发票的事儿，导致B占线（关闭了中断响应），B重拨几次后没耐心离开了（丢失）。

### 外卖2 ---- 软硬中断

基于外卖1，A外卖送达时你简短接听电话（快速硬中断），发票的事儿见面再说。不影响B电话（延迟软中断）。

## 场景

1. 如果一个任务对时间非常敏感，硬中断。
2. 如果一个任务和硬件有关，硬中断。
3. 如果一个任务要保证不被其他中断打断，硬中断。
4. 其他所有任务，考虑软中断。

## 实战

### 软中断内核线程

`ksoftirqd/< CPU编号 >` 如：ksoftirqd/0, ksoftirqd/1 ...  
`ps aux|grep softirq` 查看内核线程 (名字在[]中，一般是内核线程)

### /proc/interrupts 硬中断运行情况

### /proc/softirqs 软中断运行情况

HI  被硬中断
TIMER  定时  
NET_TX  网络发送  
NET_RX  网络接收
BLOCK  阻塞
IRQ_POLL  
TASKLET  普通
SCHED  调度  
HRTIMER  
RCU  Read-Copy Update锁

### syn flood攻击

1. 查看系统资源，可知ksoftirqd/0占用较大
2. `watch -d "cat /proc/softirqs"`，可知NET_RX较频繁
3. `sar -n DEV 1`，分析PPS, BPS，可知是接收大量的小包有问题。
4. `tcpdump -i eth0 -n tcp port 80`, 可知Flags[S]表示这些都是syn包
