# CPU 上下文切换  
  
## 概念  

        保存上一个任务运行的资源 (`CPU寄存器`和`程序计数器` Program-Counter, PC) 信息切换到加载下一个任务的资源的过程  

## 类型  

        进程上下文切换  
        线程上下文切换  
        中断上下文切换  
  
## 进程上下文切换  

      系统调用(特权模式切换) ---- 自愿

- 从用户态到内核态的转变. 即: 在发生系统调用的时候会触发两次CPU上下文切换, 从用户态 -》 内核态 和 内核态 -》 用户态  
- 在同一个进程中发生
- 涉及`user`, `sys`资源

      进程间切换 ---- 非自愿

- 一个进程切换到另一个进程
- 在两个不同进程中发生
- 涉及`user`, `sys`资源

### 触发进程调度的情景  

    进程时间片用完, 系统进行调度  
    进程申请的系统资源不足(比如内存不足)  
    调用 Sleep 函数主动挂起进程  
    当有优先级更高的进程运行时, CPU上的进程会被挂起  

## 线程上下文切换  

    前后两线程属于同一进程

- 涉及`user`, `sys`资源, 但不需要切换`虚拟内存、全局变量`等进程资源

    前后两线程属于不同进程

- 同[进程间切换]

### 线程与进程的区别  

    线程是调度的基本单位, 进程是资源拥有的基本单位  
    通俗理解: 系统内核中的任务调度实际上调度的对象是线程, 而进程只是给线程提供了虚拟内存, 全局变量等资源这些资源在线程上下文切换时是不需要修改的  
  
## 中断上下文切换  

- 中断优先级会打断进程的正常调度和执行  
- 对于同一个CPU来说, 中断处理比进程拥有更高的优先级  
- 只涉及`sys`资源

## 实战

### sysbench    多线程基准测试工具, 一般用来评估不同系统参数下DB负载情况

- `sysbench --threads=10 --timeout=300 threads run`

### [vmstat](linux-cmd-vmstat.md) `vmstat 5`

### pidstat: `pidstat -wt 5`

- cswch     自愿上下文切换, 指进程无法获取所需资源, 导致上下文切换. 如IO, 内存等系统资源不足, 进而自愿上下文切换
- nvcswch   非自愿上下文切换, 指进程由于时间片已到等原因, 被系统强制调度, 进而发生上下文切换

### /proc/interrupts    观察中断类型(变化最大的)

- `watch -d "cat /proc/interrupts"`

```bash
        CPU0    CPU1
...
RES:    2403249 575911  Rescheduling    interrupts #RES是重调度中断
...
```
