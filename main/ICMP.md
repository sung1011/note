# ICMP 互联网控制信息协议 Internet Control Message Protocolc

## 报文

```ICMP
{
    IP头
    报文: {
        类型(1byte) // 1~127的差错报文 128以上是信息报文
        代码(1byte)
        校验和(2byte)
        报文: 信息报文: {
            标识符(2byte) // 具体任务
            序号(2byte) // 唯一id
            数据
        }  / 差错报文: {
            unused(2byte),
            unused(2byte),
            IP头,
            正文(8byte)
        }

    }
}
```

| 类型 | 释义             | 场景                                                |
| ---- | ---------------- | --------------------------------------------------- |
| 0    | 回送应答         | ping的响应                                          |
| 3    | 目标不可达       | code: 3端口拒绝 0网络不可达 1主机不可达 2协议不可达 |
| 4    | 原点抑制         | code: 0控制流量, 通知主机减少数据包流量             |
| 5    | 重定向或改变路由 |
| 8    | 回送请求         | ping的请求                                          |
| 9    | 路由器公告       |
| 10   | 路由器请求       |
| 11   | 超时             | code: 0超时传输 1分段重组超时                       |
| 13   | 时间戳请求       |
| 14   | 时间戳响应       |
| 17   | 地址子网请求     |
| 18   | 地址子网应答     |

## ping

### 原理

1. ICMP类型8, 报文中加入时间戳, 用以得到RT

### 错误码

1. time out 有路由, 但数据包无法传达  
2. no route to host 网卡有问题  
3. transmit failed error code 网卡驱动有问题  
4. destination host unreachable 无路由  

### ping不通的原因

1. 对方关机/ip不存在
2. 网段不同, 通过路由也无法找到
3. 防火墙设置, 过滤了ping发出的ICMP数据包, 导致无反馈, timeout
4. Ip地址设置错误, 对于多个网卡的服务器来说, 每个网口的ip配置必须不能在同一个网段, 否则会造成路由不知选择哪一个出口
5. 网线故障
6. 未设置网关, 这个对于小网128网段, 走路由器的, 如果未配置将无法路由

### ping不通排查

1. ping -a 将IP解析为主机名

> ping是网络层, 所以不需要关注端口号

## traceroute

1. 设置特殊的TTL, 用以追踪目标IP沿途的路由器
2. 设置不分片, 用以得到路径的MTU
