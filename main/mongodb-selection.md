# MongoDB 选举

## 流程

1. 具有`投票权`的节点之间两两互发心跳
2. 当5次心跳未收到则判定为节点失联
   1. primary失联, 则secondary发起选举
   2. secondary失联, 无选举
3. 选举基于`raft`一致性算法, 选举成功必要条件是大多数投票节点存货.
4. 最多存在50个节点, 但`投票权`的节点最多7个

> [raft](algo-raft.md)

## 成员 member  

```txt
                client
                  |
                  | read/write
                  |
                Primary
              /         \
             /           \ oplog
            /             \
       Secondary        Secondary
```

- Primary
- Seconday

| 节点属性  | 可读 | 可写 | 投票 | oplog操作 | 当选primary | 否决 | 说明                                                             | 意义       |
| :-------- | :--- | :--- | :--- | :-------- | :---------- | :--- | :--------------------------------------------------------------- | ---------- |
| Primary   | O    | O    | O    | 生成      | -           | O    | 主节点                                                           | 读写       |
| Secondary | O    | X    | O    | 同步      | O           | O    | 从节点, 可被选为主                                               | 备胎       |
| Priority  | O    | X    | O    | 同步      | O           | O    | 节点的选举优先级; 值越高越容易当选; 当值为0, 不会被选举为主      | 备胎优先级 |
| Hidden    | X    | X    | O    | 同步      | X           | O    | 不能被选主(Priority为0), 并且对Driver不可见                      | 备份和统计 |
| Delayed   | X    | X    | O    | 同步      | X           | O    | 在Hidden的基础上, 其数据落后与Primary一段时间                    | 延迟备份   |
| Arbiter   | X    | X    | O    | X         | X           | O    | 只参与投票, 不能被选主, 并且不同步数据(不推荐使用)               | 纯选民     |
| Vote=0    | O    | X    | X    | 同步      | O           | O    | 不参与投票(复制集最多50个, 参与投票的最多7个, 其他成员都是Vote0) | 备胎的备胎 |

> 客户端一般会保持连接多个实例(主从从从选...都有连接), 以确保主挂后可以从其他实例拿到最新的副本集状态, 进而连接到新的主节点.(若只连接主(readPref = Primary), 主跪了, 客户端便不能得到任何服务)  
  
## 选举因素

      健康监测  

> 节点间心跳  

      节点优先级  

> 投票给优先级最高的节点  

> 当Primary发现有优先级更高Secondary, 并且该Secondary的数据落后在10s内, 则Primary会主动降级, 让优先级更高的Secondary有成为Primary的机会.  

      拥有较新的oplog  

> 拥有最新optime(最近一条oplog的时间戳)的节点才能被选为主.  

      多数派连接  

> 一个member要成为primary, 它必须与"多数派"的其他members建立连接, 如果未能与足够多的member建立连接, 事实上它本身也无法被选举为primary; 多数派参考的是“总票数”, 而不是member的个数, 因为我们可以给每个member设定不同的“票数”.假设复制集内投票成员数量为N, 则大多数为 N/2 + 1.  

